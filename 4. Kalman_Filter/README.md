# 칼만 필터 응용 예제
각 예제 별로 설명이 있다. 아래는 기본 설명이다.

# Kalman Filter(칼만필터)
## 칼만필터 알고리즘
![image](https://user-images.githubusercontent.com/42115807/85696258-bceafd80-b713-11ea-8b2a-8a8a7ecebfb1.png)<br>
**k** : 칼만 필터 알고리즘이 반복해서 수행된다는 점을 명시하기 위해 붙임<br>
윗첨자 '**-**' : 이름이 같더라도 전혀 다른 변수를 의미 -> **예측값** 의미<br>
<br>
##### 1. 1단계 : 예측단계
2단계~4단계에서 사용한 두 변수 X^-k, P-k를 계산한다.(윗첨자 '-' : 예측값을 의미)<br>
예측 단계의 계산식은 시스템 모델과 밀접하게 관련되어 있다.<br>

##### 2. 2단계 : 칼만 이득 계산
변수 P-k는 앞 단계에서 계산한 값을 사용한다.<br>
H 와 R은 칼만 필터 알고리즘 밖에서 미리 결정하는 값이다.<br>

##### 3. 3단계 : 추정값 계산
입력된 측정값으로 추정값을 계산한다.<br>
저주파 통과 필터와 관련있다.<br>
X^-k는 1단계에서 계산한 값이다.<br>

##### 4. 오차 공분산 계산
오차 공분산은 추정값이 얼마나 정확한지를 알려주는 척도이다.<br>
보통 오차 공분산을 검토해서 앞서 계산한 추정값을 믿고 쓸지 아니면 버릴지를 판단한다.<br>
<br>

아래 사진은 칼만 필터 알고리즘의 변수들을 용도별로 구분해둔 표이다.<br>
![image](https://user-images.githubusercontent.com/42115807/85733725-61326b80-b737-11ea-92e0-90801d8f5c8b.png)<br>
A, H, Q, R은 칼만 필터를 사용하는 대상 시스템 모델링할 때 쓰이는 변수다.<br>
-> 대상 시스템의 모델링에 따라 값이 다르다.<br>
-> 시스템 모델이 실제 시스템과 가까울수록 좋다.<br>
-> 나머지 변수들은 측정되거나 알고리즘에서 계산한 값이므로 임의로 변경할 수 없다.<br>
-> A와 Q : 예측 과정에서 사용되는 시스템 모델 변수 -> 최종 결과 : X^-k, P-k<br>
-> H와 R : 추정 과정에서 사용되는 시스템 모델 변수 -> 최종 결과 : X^k, Pk<br>
<br>
#### 이론 정리
1. 시스템 모델(A,Q)을 기초로 다음 시각에 상태와 오차 공분산이 어떤 값이 될지를 예측한다 : X^-k, P-k<br>
2. 측정값과 예측값의 차이를 보상해서 새로운 추정값을 계산한다. 이 추정값이 칼만 필터의 최종 결과물이다 : X^k, Pk<br>
3. 위 두 과정을 반복한다.<br>

## 추정 과정
- 추정값 계산식

![image](https://user-images.githubusercontent.com/42115807/85969391-755dbd80-ba02-11ea-9d5e-c013add580cf.png)<br>
아래 식을 잘 변형하면 저주파 필터와 연관 있게 나온다.<br>
![image](https://user-images.githubusercontent.com/42115807/85969525-dd140880-ba02-11ea-8d12-8cbc4c4fd5af.png)<br>
H를 단위행렬로 가정하면<br>
![image](https://user-images.githubusercontent.com/42115807/85969613-28c6b200-ba03-11ea-8427-d77a7d4ab0b8.png)<br>
저주파 필터식과 비교해보겠다.<br>
![image](https://user-images.githubusercontent.com/42115807/85969704-64617c00-ba03-11ea-967e-259911d101e2.png)

#### 변하는 가중치

K_k : 칼만이득(kalman gain)<br>
![image](https://user-images.githubusercontent.com/42115807/85969933-0719fa80-ba04-11ea-910a-75cf33a5df69.png)<br>
1차 저주파 필터 추정값 계산에 사용하는 가중치는 a 상수 -> 매번 가중치를 계산할 필요없다, 설계자가 임의로 적절한 값 선정한다.<br>
칼만 필터는 알고리즘을 반복하면서 K_k 값을 새로 계산하므로 추정값을 계산하는 **가중치를 매번 다시 조정**한다.<br>

#### 오차 공분산

마지막 단계인 오차 공분산 계산식은 아래 사진이다.<br>
![image](https://user-images.githubusercontent.com/42115807/85970241-d25a7300-ba04-11ea-81e5-eaf109a1af9c.png)<br>
오차 공분산은 칼만 필터의 추정값이 참값에서 얼마나 차이 나는지를 나타낸다. 즉 정확도에 대한 척도이다.<br>
Pk가 크면 추정 오차가 크고 Pk거 작으면 추정 오차가 작다.<br>
<br>
참고로 Xk에 대한 추정값(X^k)과 오차 공분산(Pk)은 정규분포 관계이다.<br>
![image](https://user-images.githubusercontent.com/42115807/85970516-aee3f800-ba05-11ea-9386-8bd0e7e0fc39.png)<br>
평균이 추정값이고 분산이 오차공분산이라는 것을 알 수 있다.<br>
아래 식은 오차 공분산에 대한 정의다. 참고 자료로 알면 좋다.<br>
![image](https://user-images.githubusercontent.com/42115807/85970858-a4762e00-ba06-11ea-8f78-5727c2692a2a.png)<br>

## 예측 과정
추정값을 예측하는 식<br>
![image](https://user-images.githubusercontent.com/42115807/85971002-00d94d80-ba07-11ea-8fe1-9d4ad5a72745.png)<br>
<br>
오차 공분산을 예측하는 식<br>
![image](https://user-images.githubusercontent.com/42115807/85971019-0fc00000-ba07-11ea-8b5b-b40fe6c117f9.png)<br>
A와 Q는 시스템 모델식으로 이미 정의되어있고 H와 R는 추정과정에서만 사용된다.<br>
주의할 점은 윗첨자 '-'의 의미는 예측한 값이라는 것을 표시한 것이다.<br>
![image](https://user-images.githubusercontent.com/42115807/85971254-a2f93580-ba07-11ea-97b2-e94d421325f7.png)<br>
<br>

#### 예측과 추정의 차이

![image](https://user-images.githubusercontent.com/42115807/85971438-0d11da80-ba08-11ea-8bc5-46ac98d09406.png)<br>
칼만 필터는 1차 저주파 통과필터와 달리 추정값을 계산할 때 직전 추정값을 바로 쓰지 않고 예측 단계를 한 번 더 거친다.<br>
이런 이유로 예측값을 사전 추정값, 추정값을 사후 추정값이라고 부르기도 한다.<br>
위 사진을 보면 둥근 화살표가 측정값을 받아 계산하는 과정으로 추정이다. 다음 시간으로 이동할 때 행렬 A를 거치는 과정이 예측이다.<br>

#### 추정값 계산식의 재해석

추정값 계산식을 보면 HX^-k눈 예측값으로 계산한 측정값이다. 다시 말해 측정값의 예측값이다.<br>
Zk-(HX^-k)는 실제 측정값과 예측한 측정값의 차이, 즉 측정값의 예측 오차이다.<br>
이러한 분석으로 추정식을 해석하면 '칼만필터는 측정값의 예측오차로 예측값을 적절히 보정하여 최종 추정값을 계산한다' 라고 할 수 있다.<br>
칼만 이득은 예측값을 얼마나 보정할지를 결정하는 인자다.<br>
추정값의 성능에 가장 큰 영향을 주는 요인은 예측값을 정확성이다. 즉 시스템 모델 변수인 A와 Q가 결정적인 영향을 준다.<br>
다시 말해 칼만 필터의 성능은 시스템 모델에 달려있다.

## 시스템 모델
**시스템 모델** : 시스템을 수학적으로 모델링하여 시스템 모델을 유도해는 것<br>
![image](https://user-images.githubusercontent.com/42115807/85972648-85c66600-ba0b-11ea-9a4a-6516babc654c.png)<br>
시스템 모델을 상태 공간 모델로 이용해서 푼다. 아래 사진은 각 변수의 의미를 나타낸다.<br>
![image](https://user-images.githubusercontent.com/42115807/85972954-4f3d1b00-ba0c-11ea-946c-945fcd04054f.png)<br>
![image](https://user-images.githubusercontent.com/42115807/85973010-785dab80-ba0c-11ea-8b4b-fdcbd8010637.png)<br>

- 상태변수(state variable) : 거리, 속도, 무게 등 우리가 관심 있는 물리적인 변수
- Wk : 시스템에 유입되어 상태변수에 영향을 주는 잡음
- Vk : 센서에서 측정되는 잡음
- A : 시스템의 운동방정식
- H : 측정값과 상태변수의 관계

이렇게 표현한 모델을 **상태공간(state space) 모델**이라고 한다.

#### 잡음의 공분산
잡음을 표현할 때는 통계학을 이용한다.<br>
칼만필터에서는 (백색)잡음이 표준정규분포를 따른다고 가정했기 때문에 잡음의 분산만 알면 된다. -> 평균이 0 이기 때문이다. <br>
이론적 기반에서 칼만 필터는 상태모델의 잡음을 아래 사진처럼 공분산 행렬로 표현한다.<br>
![image](https://user-images.githubusercontent.com/42115807/85973593-35043c80-ba0e-11ea-9565-13e76ca00f28.png)<br>
![image](https://user-images.githubusercontent.com/42115807/85973612-45b4b280-ba0e-11ea-95f3-9761b198ab67.png)<br>
(대각 행렬 : (1,1),(2,2)....,(n,n) 등 대각선 위치 외의 성분인 0인 행렬)<br>
아래 행렬은 n개의 잡음 w1,w2,w3.....wn이 있고 각 잡음의 분산이 ![image](https://user-images.githubusercontent.com/42115807/85974089-924cbd80-ba0f-11ea-8f75-904f316d4439.png) 일 때를 가정한 것이다.<br>
![image](https://user-images.githubusercontent.com/42115807/85974174-cb852d80-ba0f-11ea-8080-cbd5714d1abb.png)<br>
R도 똑같이 적용할 수 있다.<br>
<br>
![image](https://user-images.githubusercontent.com/42115807/85974274-0d15d880-ba10-11ea-8219-94aed2fd72f4.png)<br>
위 식에서 모든 변수가 스칼라라고 가정하면 역행렬은 역수라고 할 수 있다. 아래 식으로 바꿀 수 있다.<br>
![image](https://user-images.githubusercontent.com/42115807/85974352-3b93b380-ba10-11ea-8be9-bd3e18b09be9.png)<br>
위 식을 통해 R이 커지면 칼만 이득이 작아진다.<br>
![image](https://user-images.githubusercontent.com/42115807/85974637-fa4fd380-ba10-11ea-8ae8-2c0068f819c1.png)<br>
추정식을 다시보면 칼만이득 작아지면 추정값 계산에 측정값이 덜 반영되고 예측값은 더 반영된다.<br>
<br>
![image](https://user-images.githubusercontent.com/42115807/85974711-33884380-ba11-11ea-9419-b96e0afe73f4.png)<br>
Q가 커지면 오차 공분산 예측값이 커진다. 칼만 이득 식에서 오차 공분산 예측값이 커질수록 분자가 약간 더 빠르게 커지므로 칼만 이득이 커진다.<br>
따라서 측정값이 더 많이 반영되고 예측값은 덜 반영된다.<br>
R과 정반대인 행보를 보인다.<br>
<br>

- Q 증가 -> 칼만 이득 증가 -> 측정값 가중치 증가, 예측값 가중치 감소 <br>
- R 증가 -> 칼만 이득 감소 -> 측정값 가중치 감소, 예측값 가중치 증가 <br>

각 예제들의 설명은 Kalmaan_Filter 폴더 안에 있다.<br>

## 효율적인 칼만 필터 함수
실제 코드할 때 역행렬은 보통 수치해석 기법으로 구하는데 계산 시간이나 안정성을 고려하면 되도록 피하는게 좋다.<br>
-> 특히 빠르게 실행되는 실시간 시스템에 칼만 필터를 적용할 때는 어떻게든 계산시간을 단축하는 거이 바람직하다.<br>
<br>
칼만 이득의 행렬식을 풀어서 계산을 간단하게 하면 프로그램 속도를 개선할 수 있다.<br>
하지만 상태변수가 많아서 시스템 모델의 행렬이 커지면 사용하기 어려우므로 효율적인 수치해석 라이브러리를 만들거나 갖다 쓸 수 밖에 없다.<br>

## 시스템 모델의 힘
칼만 필터의 특징 : <br>
- 잡음 제거
- 변화 민감성
- 물리적인 특성 추정
- 센서 융합 능력
<br>
저주파 통과 필터는 그저 새 측정값과 이전 추정값에 가중치를 주고 더할 뿐이기 때문에 칼만 필터와 다르다.<br>
물리적인 특성을 추정할 수 있는 이유는 시스템의 수학적 모델을 알고 있다는 가정을 했기 때문이다.<br>
상태변수 사이의 연관 관계를 나타내는 시스템 모델을 통해 측정하지 않은 상태 변수를 간접적으로 추정해내는 것이다.<br>
만약 시스템 모델이 실제 시스템과 많이 다르면 추정 결과가 엉망이 될 뿐만이 아니라, 심하면 칼만 필터 알고리즘이 발산해서 전체 시스템이 망가질 수 있다.<br>
